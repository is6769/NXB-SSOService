# Сервис SSO

## Описание

SSO-сервис (Single Sign-On) — это компонент телекоммуникационной системы, отвечающий за аутентификацию и авторизацию пользователей. Сервис обеспечивает единую точку входа для всех пользователей системы.

## Назначение

SSO-сервис выполняет следующие функции:
- Аутентификация пользователей с разными ролями (абонентов, менеджеров)
- Генерация и проверка JWT-токенов
- Создание учетных записей для новых абонентов
- Обеспечение безопасности всей системы через централизованное управление доступом

## Логика работы

### Аутентификация пользователей

1. Клиент отправляет запрос к эндпоинту `/auth/login` с учетными данными (MSISDN абонента)
2. Сервис проверяет наличие пользователя с указанным номером в базе данных
3. В случае успеха:
   - Создается объект `AppUserDetails`
   - Генерируется JWT-токен с включенной информацией о роли, номере и идентификаторе пользователя
   - Токен возвращается клиенту

### Проверка токенов (интроспекция)

1. Клиент отправляет запрос к эндпоинту `/auth/introspection` с токеном
2. Сервис проверяет:
   - Валидность подписи токена
   - Срок действия токена
3. Если токен валиден, возвращается payload токена с дополнительным полем `active: true`
4. Если токен невалиден, возвращается только `active: false`

### Регистрация новых абонентов

1. Сервис получает сообщение о создании нового абонента через RabbitMQ
2. Сообщение содержит `NewSubscriberDTO` с идентификатором и номером абонента
3. Сервис создает новую учетную запись с ролью `ROLE_SUBSCRIBER`
4. Пользователь сохраняется в базе данных и становится доступным для аутентификации

### Инициализация

При запуске сервис проверяет наличие менеджеров в системе:
- Если менеджеры отсутствуют, автоматически создается учетная запись с ролью `ROLE_MANAGER` и номером `-77777777777`

## API Endpoints

### Аутентификация

- `POST /auth/login` - Вход в систему
  - Входные данные: `CredentialsDTO` (msisdn)
  - Выходные данные: `TokenDTO` (JWT-токен)

### Проверка токенов

- `POST /auth/introspection` - Проверка валидности токена
  - Входные данные: `TokenDTO` (token)
  - Выходные данные: Карта с информацией о токене и его статусе

## Структура данных

### Пользователи

Основной сущностью является `AppUser`:
- `id` - Уникальный идентификатор
- `msisdn` - Номер телефона пользователя
- `role` - Роль пользователя (ROLE_SUBSCRIBER, ROLE_MANAGER)
- `referenceId` - Связь с идентификатором в других системах (например, ID абонента в BRT)

### JWT-токены

Токены содержат следующую информацию:
- `msisdn` - Номер телефона пользователя
- `role` - Роль пользователя
- `ref_id` - Референсный ID (для абонентов — ID в BRT-системе)
- Стандартные поля JWT: время выпуска, время истечения

## Интеграция с RabbitMQ

Сервис подписан на следующие очереди:
- Очередь новых абонентов: получение уведомлений о создании абонентов
- Dead Letter Queue: обработка сообщений с ошибками

## Безопасность

- JWT-токены подписываются с использованием алгоритма HS512
- Токены имеют время жизни 1 час
- Для управления доступом используется Spring Security

## Технические детали

### Технологический стек

- **Spring Boot 3.4.5**: Основной фреймворк
- **Spring Security**: Для управления аутентификацией
- **JJWT 0.12.6**: Для работы с JWT-токенами
- **Spring Data JPA**: Для работы с базой данных
- **PostgreSQL**: База данных для хранения пользователей
- **Spring AMQP**: Для работы с RabbitMQ
- **Liquibase**: Для управления миграциями базы данных

### База данных

**PostgreSQL**
- JDBC URL: `jdbc:postgresql://localhost:5434/sso-db`
- Пользователь: `postgres`
- Пароль: `postgres`
- Схема: `public`

В контейнерной среде:
- JDBC URL: `jdbc:postgresql://sso-db:5432/sso-db`

### Обработка ошибок

- Для сообщений RabbitMQ реализован механизм Dead Letter Queue
- Для API реализована стандартная обработка ошибок Spring
